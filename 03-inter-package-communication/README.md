# Inter-Package Communication Tutorial: Overview

Welcome to the "Inter-Package Communication" tutorial for Brane! This tutorial demonstrates how to connect multiple packages within a Brane workflow to pass information seamlessly between them.

## Overview

In real-world applications, tasks are often modular, requiring different components to work together. This tutorial focuses on demonstrating how to:
- Create two packages that communicate via JSON data.
- Build a workflow to connect these packages.
- Enhance the workflow with additional features for smarter execution.

By the end of this tutorial, you will have a deeper understanding of how to design modular workflows and integrate packages to create reusable and scalable pipelines.

## Structure of the Tutorial

This tutorial is divided into the following steps:
1. **Create Package 1**: Learn how to build a package that generates structured data.
2. **Create Package 2**: Develop a package that consumes and processes the data from Package 1.
3. **Build the Workflow**: Write a Brane workflow to connect the two packages.
4. **Enhance the Workflow** (Optional): Add logging or conditional logic for smarter execution.
5. **Test and Run the Workflow**: Run the workflow and review the results.

## Prerequisites

Before starting this tutorial, make sure you:
- Have Brane installed and configured on your machine.
- Completed the [First Package Tutorial](../02-first-package/README.md) to understand the basics of package creation.

# Step 1 - Create Package 1

In this step, we’ll create the first package, which generates structured data. This package will serve as the starting point in our workflow and produce JSON output that will be passed to the second package.

## Overview

Package 1 generates a simple JSON object containing:
- A message
- A timestamp
- The source of the data

This JSON object will be consumed by Package 2 in the next step.

## Files

- `generator.py`: Python script for generating the JSON data.
- `container.yml`: Configuration file for the package.

## Instructions

### Step 1: Write the Python Script
1. Create a file named `generator.py`.
2. Write the following Python code:

```python
#!/usr/bin/env python3
import json
from datetime import datetime

def generate_message():
    data = {
        "message": "Hello from Package 1!",
        "timestamp": datetime.now().isoformat(),
        "source": "Package 1"
    }
    return data

if __name__ == "__main__":
    output = generate_message()
    print(f'message_json: "{output}"')
```

This script generates a JSON object containing a message, the current timestamp, and the source of the data.

### Step 2: Create the `container.yml` File
1. Create a file named `container.yml`.
2. Add the following content to define the package:

```yaml
name: generator
version: 1.0.0
kind: ecu

dependencies:
- python3

files:
- generator.py

entrypoint:
  kind: task
  exec: generator.py

actions:
  'generate_message':
    command:
    input:
    output:
    - name: message_json
      type: string
```

This configuration file:
- Specifies the name (`generator`) and version (`1.0.0`) of the package.
- Lists the required dependencies.
- Defines the entrypoint and actions for the package.

### Step 3: Build the Package
1. Open your terminal and navigate to the directory containing `generator.py` and `container.yml`.
2. Build the package with the following command:
```
brane package build container.yml
```

### Step 4: Test the Package
1. Run the following command to test the package:

```
brane package test generator
```

2. Now you need to select a task to run. We currently have only one task available, `generate_message`, which you can execute by pressing enter.

```
asa@host03:~/$ brane package test generator
? The function the execute ›
❯ generate_message
```

3. You should see output similar to this:
```
asa@host03:~/$ brane package test generator
✔ The function the execute · generate_message

Result: {'message': 'Hello from Package 1!', 'timestamp': '2024-11-28T02:30:42.702967', 'source': 'Package 1'} [String]
```

# Step 2 - Create Package 2

In this step, we’ll create the second package, which consumes the JSON data generated by Package 1 and processes it. This package will demonstrate how to parse input data, perform transformations, and produce structured output.

## Overview

Package 2 takes a JSON input, extracts specific fields, processes them, and returns a new JSON object containing:
- The original message in uppercase
- The timestamp from the input
- Information about where the data was processed

## Files

- `processor.py`: Python script for consuming and processing JSON data.
- `container.yml`: Configuration file for the package.

## Instructions

### Step 1: Write the Python Script
1. Create a file named `processor.py`.
2. Write the following Python code:

```python
#!/usr/bin/env python3
import json
import os

def process_message(input_json):
    # Parse the input JSON string
    data = json.loads(input_json.replace("'", '"'))

    # Extract and process the fields
    message = data.get("message", "No message provided").upper()
    timestamp = data.get("timestamp", "Unknown time")
    source = data.get("source", "Unknown source")

    # Construct a processed response
    result = {
        "original_message": message,
        "processed_at": "Package 2",
        "received_from": source,
        "timestamp": timestamp
    }
    return result

if __name__ == "__main__":
    # Read the JSON input from stdin (simulated input for testing)
    input_json = json.loads(os.environ['INPUT_JSON'])

    # Process the input and produce the result
    output = process_message(input_json)

    # Print the result as a JSON string
    print(f'result_json: "{output}"' )
```

This script:
- Parses the JSON input.
- Processes the fields (e.g., converts the message to uppercase).
- Returns a new JSON object with processed data.

### Step 2: Create the `container.yml` File
1. Create a file named `container.yml`.
2. Add the following content to define the package:

```YAML
name: processor
version: 1.0.0
kind: ecu

dependencies:
- python3

files:
- processor.py

entrypoint:
  kind: task
  exec: processor.py

actions:
  'process_message':
    command:
    input:
    - name: input_json
      type: string
    output:
    - name: result_json
      type: string
```

This configuration file:
- Specifies the name (`processor`) and version (`1.0.0`) of the package.
- Lists the required dependencies.
- Defines the entrypoint and actions for the package, including an input parameter (`input_json`) and an output parameter (`result_json`).

### Step 3: Build the Package
1. Open your terminal and navigate to the directory containing `processor.py` and `container.yml`.
2. Build the package with the following command:
```
brane package build container.yml
```

### Step 4: Test the Package
1. Run the following command to test the package:
```
brane package test processor
```

2. Now you need to select a task to run. We currently have only one task available, `process_message`, which you can execute by pressing enter.

```
asa@host03:~/$ brane package test processor
? The function the execute ›
❯ process_message
```

3. Now you need to provied a JSON input, feel free to use: `{"message": "Hello from Package 1!", "timestamp": "2024-11-17T10:23:45.123456", "source": "Package 1"}`

```
asa@host03:~/$ brane package test processor
✔ The function the execute · process_message

Please provide input for the chosen function:

? input_json [string] › {"message": "Hello from Package 1!", "timestamp": "2024-11-17T10:23:45.123456", "source": "Package 1"}
```

4. Hit enter and you should see output similar to this:

```
asa@host03:~/$ brane package test processor
✔ The function the execute · process_message

Please provide input for the chosen function:

✔ input_json [string] · {"message": "Hello from Package 1!", "timestamp": "2024-11-17T10:23:45.123456", "source": "Package 1"}

Result: {'original_message': 'HELLO FROM PACKAGE 1!', 'processed_at': 'Package 2', 'received_from': 'Package 1', 'timestamp': '2024-11-17T10:23:45.123456'} [String]
```

# Step 3 - Build the Workflow

Now that we’ve created and tested both packages, it’s time to connect them in a Brane workflow. This workflow will demonstrate how to pass data from one package to another, creating a seamless pipeline.

## Overview

In this step, we’ll:
1. Import the two packages into a workflow script.
2. Use the output from Package 1 as input for Package 2.
3. Print the final result to the console.

## Files

- `workflow.bs`: The workflow script connecting the two packages.

## Instructions

### Step 1: Write the Workflow Script
1. Create a file named `workflow.bs`.
2. Write the following workflow code:

```
import generator;
import processor;

#[on("localhost")]
// Step 1: Call Package 1 to generate the message
let message_json := generate_message();

// Step 2: Pass the output from Package 1 to Package 2 for processing
let result_json := process_message(message_json);

// Step 3: Print the final result
println("Final result from Package 2:");
println(result_json);
```

This script:
- Calls the `generate_message` action from Package 1 and stores the JSON output in `message_json`.
- Passes `message_json` as input to the `process_message` action in Package 2.
- Prints the final processed JSON result from Package 2.

### Step 2: Run the Workflow
1. Open your terminal and navigate to the directory containing `workflow.bs`.
2. Run the workflow with the following command:
```
brane workflow run workflow.bs
```

### Step 3: Check the Output
If everything is set up correctly, you should see output similar to this in your terminal:

```
asa@host03:~/$ brane workflow run workflow.bs
Final result from Package 2:
{'original_message': 'HELLO FROM PACKAGE 1!', 'processed_at': 'Package 2', 'received_from': 'Package 1', 'timestamp': '2024-11-28T02:57:08.149038'}
```

---

Happy learning, and enjoy exploring Brane!
